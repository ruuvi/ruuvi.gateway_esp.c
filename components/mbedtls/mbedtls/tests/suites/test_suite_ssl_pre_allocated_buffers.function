/* BEGIN_HEADER */
#include <mbedtls/ssl_misc.h>
#include <mbedtls/timing.h>
#include <mbedtls/debug.h>
#include <mbedtls/pk.h>
#include <test/ssl_helpers.h>

#include <constant_time_internal.h>
#include <test/constant_flow.h>
/* END_HEADER */

/* BEGIN_DEPENDENCIES
 * depends_on:MBEDTLS_SSL_TLS_C
 * END_DEPENDENCIES
 */

/* BEGIN_CASE */
void ssl_pre_allocated_buffers_basic()
{
    mbedtls_ssl_context ssl;
    mbedtls_ssl_config conf;
    uint8_t *in_buf = NULL;
    uint8_t *out_buf = NULL;
    const size_t in_buf_size = MBEDTLS_SSL_IN_BUFFER_LEN;
    const size_t out_buf_size = MBEDTLS_SSL_OUT_BUFFER_LEN;

    mbedtls_ssl_init(&ssl);
    mbedtls_ssl_config_init(&conf);
    USE_PSA_INIT();

    /* Allocate buffers */
    in_buf = mbedtls_calloc(1, in_buf_size);
    TEST_ASSERT(in_buf != NULL);
    out_buf = mbedtls_calloc(1, out_buf_size);
    TEST_ASSERT(out_buf != NULL);

    /* Configure SSL with defaults */
    TEST_ASSERT(mbedtls_ssl_config_defaults(&conf,
                                            MBEDTLS_SSL_IS_CLIENT,
                                            MBEDTLS_SSL_TRANSPORT_STREAM,
                                            MBEDTLS_SSL_PRESET_DEFAULT) == 0);

    /* Set pre-allocated buffers in config */
    conf.p_ssl_in_buf = in_buf;
    conf.p_ssl_out_buf = out_buf;

    /* Setup SSL context - should use pre-allocated buffers */
    TEST_ASSERT(mbedtls_ssl_setup(&ssl, &conf) == 0);

    /* Verify that SSL context uses the pre-allocated buffers */
    TEST_ASSERT(ssl.in_buf == in_buf);
    TEST_ASSERT(ssl.out_buf == out_buf);
    TEST_ASSERT(ssl.flag_in_buf_pre_allocated == true);
    TEST_ASSERT(ssl.flag_out_buf_pre_allocated == true);

exit:
    /* Free SSL context - should NOT free the pre-allocated buffers, only zero them */
    mbedtls_ssl_free(&ssl);
    mbedtls_ssl_config_free(&conf);

    /* We must free the pre-allocated buffers ourselves */
    mbedtls_free(in_buf);
    mbedtls_free(out_buf);
    USE_PSA_DONE();
}
/* END_CASE */

/* BEGIN_CASE */
void ssl_pre_allocated_buffers_partial()
{
    mbedtls_ssl_context ssl;
    mbedtls_ssl_config conf;
    uint8_t *in_buf = NULL;
    const size_t in_buf_size = MBEDTLS_SSL_IN_BUFFER_LEN;

    mbedtls_ssl_init(&ssl);
    mbedtls_ssl_config_init(&conf);
    USE_PSA_INIT();

    /* Allocate only input buffer */
    in_buf = mbedtls_calloc(1, in_buf_size);
    TEST_ASSERT(in_buf != NULL);

    /* Configure SSL with defaults */
    TEST_ASSERT(mbedtls_ssl_config_defaults(&conf,
                                            MBEDTLS_SSL_IS_CLIENT,
                                            MBEDTLS_SSL_TRANSPORT_STREAM,
                                            MBEDTLS_SSL_PRESET_DEFAULT) == 0);

    /* Set only pre-allocated input buffer */
    conf.p_ssl_in_buf = in_buf;
    conf.p_ssl_out_buf = NULL;

    /* Setup SSL context */
    TEST_ASSERT(mbedtls_ssl_setup(&ssl, &conf) == 0);

    /* Verify input buffer is pre-allocated */
    TEST_ASSERT(ssl.in_buf == in_buf);
    TEST_ASSERT(ssl.flag_in_buf_pre_allocated == true);

    /* Verify output buffer is dynamically allocated */
    TEST_ASSERT(ssl.out_buf != NULL);
    TEST_ASSERT(ssl.out_buf != in_buf);
    TEST_ASSERT(ssl.flag_out_buf_pre_allocated == false);

exit:
    mbedtls_ssl_free(&ssl);
    mbedtls_ssl_config_free(&conf);
    mbedtls_free(in_buf);
    USE_PSA_DONE();
}
/* END_CASE */

/* BEGIN_CASE */
void ssl_pre_allocated_buffers_no_resize()
{
#if defined(MBEDTLS_SSL_VARIABLE_BUFFER_LENGTH)
    mbedtls_ssl_context ssl;
    mbedtls_ssl_config conf;
    uint8_t *in_buf = NULL;
    uint8_t *out_buf = NULL;
    uint8_t *in_buf_ptr_before, *out_buf_ptr_before;
    const size_t in_buf_size = MBEDTLS_SSL_IN_BUFFER_LEN;
    const size_t out_buf_size = MBEDTLS_SSL_OUT_BUFFER_LEN;

    mbedtls_ssl_init(&ssl);
    mbedtls_ssl_config_init(&conf);
    USE_PSA_INIT();

    /* Allocate buffers */
    in_buf = mbedtls_calloc(1, in_buf_size);
    TEST_ASSERT(in_buf != NULL);
    out_buf = mbedtls_calloc(1, out_buf_size);
    TEST_ASSERT(out_buf != NULL);

    /* Configure SSL with defaults */
    TEST_ASSERT(mbedtls_ssl_config_defaults(&conf,
                                            MBEDTLS_SSL_IS_CLIENT,
                                            MBEDTLS_SSL_TRANSPORT_STREAM,
                                            MBEDTLS_SSL_PRESET_DEFAULT) == 0);

    /* Set pre-allocated buffers */
    conf.p_ssl_in_buf = in_buf;
    conf.p_ssl_out_buf = out_buf;

    /* Setup SSL context */
    TEST_ASSERT(mbedtls_ssl_setup(&ssl, &conf) == 0);

    /* Save buffer pointers */
    in_buf_ptr_before = ssl.in_buf;
    out_buf_ptr_before = ssl.out_buf;

    /* Initialize handshake - with variable buffer length, this might trigger
     * buffer resizing, but with pre-allocated buffers it should NOT */
    TEST_ASSERT(ssl.handshake == NULL);
    /* We can't easily trigger a full handshake here, but we can verify
     * that the buffers remain unchanged after various operations */

    /* Verify buffers haven't been reallocated */
    TEST_ASSERT(ssl.in_buf == in_buf_ptr_before);
    TEST_ASSERT(ssl.out_buf == out_buf_ptr_before);
    TEST_ASSERT(ssl.flag_in_buf_pre_allocated == true);
    TEST_ASSERT(ssl.flag_out_buf_pre_allocated == true);

exit:
    mbedtls_ssl_free(&ssl);
    mbedtls_ssl_config_free(&conf);
    mbedtls_free(in_buf);
    mbedtls_free(out_buf);
    USE_PSA_DONE();
#endif /* MBEDTLS_SSL_VARIABLE_BUFFER_LENGTH */
}
/* END_CASE */

/* BEGIN_CASE */
void ssl_pre_allocated_buffers_zero_on_free()
{
    mbedtls_ssl_context ssl;
    mbedtls_ssl_config conf;
    uint8_t *in_buf = NULL;
    uint8_t *out_buf = NULL;
    const size_t in_buf_size = MBEDTLS_SSL_IN_BUFFER_LEN;
    const size_t out_buf_size = MBEDTLS_SSL_OUT_BUFFER_LEN;
    const uint8_t pattern = 0xAA;

    mbedtls_ssl_init(&ssl);
    mbedtls_ssl_config_init(&conf);
    USE_PSA_INIT();

    /* Allocate and fill buffers with a pattern */
    in_buf = mbedtls_calloc(1, in_buf_size);
    TEST_ASSERT(in_buf != NULL);
    memset(in_buf, pattern, in_buf_size);

    out_buf = mbedtls_calloc(1, out_buf_size);
    TEST_ASSERT(out_buf != NULL);
    memset(out_buf, pattern, out_buf_size);

    /* Configure SSL */
    TEST_ASSERT(mbedtls_ssl_config_defaults(&conf,
                                            MBEDTLS_SSL_IS_CLIENT,
                                            MBEDTLS_SSL_TRANSPORT_STREAM,
                                            MBEDTLS_SSL_PRESET_DEFAULT) == 0);

    conf.p_ssl_in_buf = in_buf;
    conf.p_ssl_out_buf = out_buf;

    /* Setup SSL context */
    TEST_ASSERT(mbedtls_ssl_setup(&ssl, &conf) == 0);

    /* Free SSL context - should zero the buffers but not free them */
    mbedtls_ssl_free(&ssl);

    /* Verify buffers are zeroed (check first and last few bytes) */
    TEST_ASSERT(in_buf[0] == 0);
    TEST_ASSERT(in_buf[in_buf_size - 1] == 0);
    TEST_ASSERT(out_buf[0] == 0);
    TEST_ASSERT(out_buf[out_buf_size - 1] == 0);

    /* Verify middle sections are also zeroed */
    size_t non_zero_count = 0;
    for (size_t i = 0; i < in_buf_size; i++) {
        if (in_buf[i] != 0) {
            non_zero_count++;
        }
    }
    TEST_ASSERT(non_zero_count == 0);

    non_zero_count = 0;
    for (size_t i = 0; i < out_buf_size; i++) {
        if (out_buf[i] != 0) {
            non_zero_count++;
        }
    }
    TEST_ASSERT(non_zero_count == 0);

exit:
    mbedtls_ssl_config_free(&conf);
    mbedtls_free(in_buf);
    mbedtls_free(out_buf);
    USE_PSA_DONE();
}
/* END_CASE */

/* BEGIN_CASE */
void ssl_no_pre_allocated_buffers_still_works()
{
    mbedtls_ssl_context ssl;
    mbedtls_ssl_config conf;

    mbedtls_ssl_init(&ssl);
    mbedtls_ssl_config_init(&conf);
    USE_PSA_INIT();

    /* Configure SSL with defaults */
    TEST_ASSERT(mbedtls_ssl_config_defaults(&conf,
                                            MBEDTLS_SSL_IS_CLIENT,
                                            MBEDTLS_SSL_TRANSPORT_STREAM,
                                            MBEDTLS_SSL_PRESET_DEFAULT) == 0);

    /* Do NOT set pre-allocated buffers (NULL by default) */
    TEST_ASSERT(conf.p_ssl_in_buf == NULL);
    TEST_ASSERT(conf.p_ssl_out_buf == NULL);

    /* Setup SSL context - should allocate buffers dynamically */
    TEST_ASSERT(mbedtls_ssl_setup(&ssl, &conf) == 0);

    /* Verify buffers are allocated */
    TEST_ASSERT(ssl.in_buf != NULL);
    TEST_ASSERT(ssl.out_buf != NULL);

    /* Verify they are NOT marked as pre-allocated */
    TEST_ASSERT(ssl.flag_in_buf_pre_allocated == false);
    TEST_ASSERT(ssl.flag_out_buf_pre_allocated == false);

exit:
    /* This should free the dynamically allocated buffers */
    mbedtls_ssl_free(&ssl);
    mbedtls_ssl_config_free(&conf);
    USE_PSA_DONE();
}
/* END_CASE */

/* BEGIN_CASE depends_on:MBEDTLS_SSL_VARIABLE_BUFFER_LENGTH */
void ssl_pre_allocated_buffers_custom_size()
{
    mbedtls_ssl_context ssl;
    mbedtls_ssl_config conf;
    uint8_t *in_buf = NULL;
    uint8_t *out_buf = NULL;
    const uint32_t custom_in_content_len = 8192;
    const uint32_t custom_out_content_len = 4096;
    size_t in_buf_size, out_buf_size;

    mbedtls_ssl_init(&ssl);
    mbedtls_ssl_config_init(&conf);
    USE_PSA_INIT();

    /* Configure SSL with defaults */
    TEST_ASSERT(mbedtls_ssl_config_defaults(&conf,
                                            MBEDTLS_SSL_IS_CLIENT,
                                            MBEDTLS_SSL_TRANSPORT_STREAM,
                                            MBEDTLS_SSL_PRESET_DEFAULT) == 0);

    /* Set custom content lengths */
    conf.ssl_in_content_len = custom_in_content_len;
    conf.ssl_out_content_len = custom_out_content_len;

    /* Calculate required buffer sizes */
    in_buf_size = mbedtls_ssl_get_in_buffer_size(custom_in_content_len);
    out_buf_size = mbedtls_ssl_get_out_buffer_size(custom_out_content_len);

    /* Allocate buffers */
    in_buf = mbedtls_calloc(1, in_buf_size);
    TEST_ASSERT(in_buf != NULL);
    out_buf = mbedtls_calloc(1, out_buf_size);
    TEST_ASSERT(out_buf != NULL);

    /* Set pre-allocated buffers */
    conf.p_ssl_in_buf = in_buf;
    conf.p_ssl_out_buf = out_buf;

    /* Setup SSL context */
    TEST_ASSERT(mbedtls_ssl_setup(&ssl, &conf) == 0);

    /* Verify buffers and sizes */
    TEST_ASSERT(ssl.in_buf == in_buf);
    TEST_ASSERT(ssl.out_buf == out_buf);
    TEST_ASSERT(ssl.in_buf_len == in_buf_size);
    TEST_ASSERT(ssl.out_buf_len == out_buf_size);
    TEST_ASSERT(ssl.flag_in_buf_pre_allocated == true);
    TEST_ASSERT(ssl.flag_out_buf_pre_allocated == true);

exit:
    mbedtls_ssl_free(&ssl);
    mbedtls_ssl_config_free(&conf);
    mbedtls_free(in_buf);
    mbedtls_free(out_buf);
    USE_PSA_DONE();
}
/* END_CASE */
